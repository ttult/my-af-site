name: Deploy Hugo site to GitHub Pages

on:
  push:
    branches:
      - main  # ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã«pushã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # âš ï¸ ä¿®æ­£ 1: ENVã‚’å®šç¾©ã™ã‚‹ï¼ˆã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã¯å¤‰æ›´ãªã—ï¼‰
    env:
      CUSTOM_DOMAIN_URL: ${{ vars.CUSTOM_DOMAIN }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'

      # ==========================================================
      # ðŸ› ï¸ ä¿®æ­£ 2: baseURL ã®ä¸Šæ›¸ãï¼ˆå‚ç…§æ–¹æ³•ã®ä¿®æ­£ï¼‰
      # ==========================================================
      # ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯å‚ç…§ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ä»Šå›žã¯ç›´æŽ¥ vars ã‚’å‚ç…§ã™ã‚‹ã“ã¨ã§å›žé¿ã—ã¾ã™ã€‚
      - name: Build Hugo site (Override baseURL)
        # run ã‚³ãƒžãƒ³ãƒ‰å†…ã§ç›´æŽ¥ vars.CUSTOM_DOMAIN ã‚’å‚ç…§
        run: hugo --minify --baseURL ${{ vars.CUSTOM_DOMAIN }} 


      # ==========================================================
      # ðŸ› ï¸ ä¿®æ­£ 3: CNAME ãƒ•ã‚¡ã‚¤ãƒ«ã®å‹•çš„ä½œæˆï¼ˆæ–‡å­—åˆ—æ“ä½œã®ä¿®æ­£ï¼‰
      # ==========================================================
      - name: Create CNAME file from Variable
        run: |
          # Bashã®æ–‡å­—åˆ—ç½®æ›æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
          # 1. https:// ã‚’å‰Šé™¤
          DOMAIN_ONLY="${{ vars.CUSTOM_DOMAIN }/https:\/\//}"
          # 2. æœ«å°¾ã® / ã‚’å‰Šé™¤ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
          DOMAIN_ONLY="${DOMAIN_ONLY/\//}"
          
          # 3. public/CNAME ã«ãƒ‰ãƒ¡ã‚¤ãƒ³åã®ã¿ã‚’æ›¸ãè¾¼ã‚€
          echo "${DOMAIN_ONLY}" > ./public/CNAME
          echo "âœ… CNAME file created with: ${DOMAIN_ONLY}"


      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          force_orphan: true