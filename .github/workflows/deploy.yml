name: Deploy Hugo site to GitHub Pages

on:
  push:
    branches:
      - main  # ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã«pushã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # ðŸ“ envã®å®šç¾©ã¯ç¶­æŒï¼ˆã“ã®æ–¹ãŒåˆ†ã‹ã‚Šã‚„ã™ã„ãŸã‚ï¼‰
    env:
      CUSTOM_DOMAIN_URL: ${{ vars.CUSTOM_DOMAIN }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'

      # ==========================================================
      # ðŸ› ï¸ ä¿®æ­£ 1: baseURL ã®ä¸Šæ›¸ã
      # ==========================================================
      - name: Build Hugo site (Override baseURL)
        # Hugoã‚³ãƒžãƒ³ãƒ‰ã« Variables ã®å€¤ï¼ˆãƒ•ãƒ«URLï¼‰ã‚’ç›´æŽ¥æ¸¡ã™
        run: hugo --minify --baseURL ${{ vars.CUSTOM_DOMAIN }} 


      # ==========================================================
      # ðŸ› ï¸ ä¿®æ­£ 2: CNAME ãƒ•ã‚¡ã‚¤ãƒ«ã®å‹•çš„ä½œæˆï¼ˆæ§‹æ–‡ã‚¨ãƒ©ãƒ¼å›žé¿ã®ãŸã‚ä¿®æ­£ï¼‰
      # ==========================================================
      # è¤‡æ•°ã®ã‚³ãƒžãƒ³ãƒ‰ã‚’ '|' ã§å›²ã‚€ã“ã¨ã§ã€å˜ä¸€ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã—ã¦å®Ÿè¡Œã•ã›ã‚‹
      - name: Create CNAME file from Variable
        shell: bash 
        run: |
          # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å€¤ã‚’å–å¾—
          FULL_URL="${{ vars.CUSTOM_DOMAIN }}"
          
          # 1. https:// ã‚’å‰Šé™¤
          DOMAIN_ONLY="${FULL_URL/https:\/\//}"
          
          # 2. æœ«å°¾ã® / ã‚’å‰Šé™¤ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
          DOMAIN_ONLY="${DOMAIN_ONLY/\//}"
          
          # 3. public/CNAME ã«ãƒ‰ãƒ¡ã‚¤ãƒ³åã®ã¿ã‚’æ›¸ãè¾¼ã‚€
          echo "${DOMAIN_ONLY}" > ./public/CNAME
          echo "âœ… CNAME file created with: ${DOMAIN_ONLY}"


      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          force_orphan: true