name: Deploy Hugo site to GitHub Pages

on:
  push:
    branches:
      - main  # メインブランチにpushされたときに実行

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # ⚠️ 修正 1: ENVを定義する（このブロックは変更なし）
    env:
      CUSTOM_DOMAIN_URL: ${{ vars.CUSTOM_DOMAIN }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'

      # ==========================================================
      # 🛠️ 修正 2: baseURL の上書き（参照方法の修正）
      # ==========================================================
      # 以前のバージョンでは参照が失敗しました。今回は直接 vars を参照することで回避します。
      - name: Build Hugo site (Override baseURL)
        # run コマンド内で直接 vars.CUSTOM_DOMAIN を参照
        run: hugo --minify --baseURL ${{ vars.CUSTOM_DOMAIN }} 


      # ==========================================================
      # 🛠️ 修正 3: CNAME ファイルの動的作成（文字列操作の修正）
      # ==========================================================
      - name: Create CNAME file from Variable
        run: |
          # Bashの文字列置換機能を使用します。
          # 1. https:// を削除
          DOMAIN_ONLY="${{ vars.CUSTOM_DOMAIN }/https:\/\//}"
          # 2. 末尾の / を削除（もしあれば）
          DOMAIN_ONLY="${DOMAIN_ONLY/\//}"
          
          # 3. public/CNAME にドメイン名のみを書き込む
          echo "${DOMAIN_ONLY}" > ./public/CNAME
          echo "✅ CNAME file created with: ${DOMAIN_ONLY}"


      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          force_orphan: true