name: Deploy Hugo site to GitHub Pages

on:
  push:
    branches:
      - main  # メインブランチにpushされたときに実行

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # ==========================================================
    # 🚨 必須の修正: Environment の指定 🚨
    # ==========================================================
    environment: github-pages # 👈 この行を追加することで Variables が読み込まれる
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'

      # ==========================================================
      # 修正 1: baseURL の上書き
      # ==========================================================
      - name: Build Hugo site (Override baseURL)
        run: |
          # Variables の値をシェル変数に代入
          HUGO_BASE_URL="${{ vars.CUSTOM_DOMAIN }}"
          
          # Hugo ビルド実行
          hugo --minify --baseURL "$HUGO_BASE_URL"
          echo "✅ Building site with baseURL: $HUGO_BASE_URL" # ログで確認用に追加

      # ==========================================================
      # 修正 2: CNAME ファイルの動的作成
      # ==========================================================
      - name: Create CNAME file from Variable
        shell: bash 
        run: |
          # Variables の値をシェル変数に代入
          FULL_URL="${{ vars.CUSTOM_DOMAIN }}"
          
          # 1. https:// を削除
          DOMAIN_ONLY="${FULL_URL/https:\/\//}"
          
          # 2. 末尾の / を削除（もしあれば）
          DOMAIN_ONLY="${DOMAIN_ONLY/\//}"
          
          # 3. public/CNAME にドメイン名のみを書き込む
          echo "${DOMAIN_ONLY}" > ./public/CNAME
          echo "✅ CNAME file created with: ${DOMAIN_ONLY}"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          force_orphan: true