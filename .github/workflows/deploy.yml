name: Deploy Hugo site to GitHub Pages

on:
  push:
    branches:
      - main  # ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã«pushã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # ==========================================================
    # ðŸš¨ å¿…é ˆã®ä¿®æ­£: Environment ã®æŒ‡å®š ðŸš¨
    # ==========================================================
    environment: github-pages # ðŸ‘ˆ ã“ã®è¡Œã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ Variables ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'

      # ==========================================================
      # ä¿®æ­£ 1: baseURL ã®ä¸Šæ›¸ã
      # ==========================================================
      - name: Build Hugo site (Override baseURL)
        run: |
          # Variables ã®å€¤ã‚’ã‚·ã‚§ãƒ«å¤‰æ•°ã«ä»£å…¥
          HUGO_BASE_URL="${{ vars.CUSTOM_DOMAIN }}"
          
          # Hugo ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
          hugo --minify --baseURL "$HUGO_BASE_URL"
          echo "âœ… Building site with baseURL: $HUGO_BASE_URL" # ãƒ­ã‚°ã§ç¢ºèªç”¨ã«è¿½åŠ 

      # ==========================================================
      # ä¿®æ­£ 2: CNAME ãƒ•ã‚¡ã‚¤ãƒ«ã®å‹•çš„ä½œæˆ
      # ==========================================================
      - name: Create CNAME file from Variable
        shell: bash 
        run: |
          # Variables ã®å€¤ã‚’ã‚·ã‚§ãƒ«å¤‰æ•°ã«ä»£å…¥
          FULL_URL="${{ vars.CUSTOM_DOMAIN }}"
          
          # 1. https:// ã‚’å‰Šé™¤
          DOMAIN_ONLY="${FULL_URL/https:\/\//}"
          
          # 2. æœ«å°¾ã® / ã‚’å‰Šé™¤ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
          DOMAIN_ONLY="${DOMAIN_ONLY/\//}"
          
          # 3. public/CNAME ã«ãƒ‰ãƒ¡ã‚¤ãƒ³åã®ã¿ã‚’æ›¸ãè¾¼ã‚€
          echo "${DOMAIN_ONLY}" > ./public/CNAME
          echo "âœ… CNAME file created with: ${DOMAIN_ONLY}"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          force_orphan: true