name: Deploy Hugo site to GitHub Pages

on:
  push:
    branches:
      - main  # メインブランチにpushされたときに実行

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # 📝 envの定義は維持（この方が分かりやすいため）
    env:
      CUSTOM_DOMAIN_URL: ${{ vars.CUSTOM_DOMAIN }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'

      # ==========================================================
      # 🛠️ 修正 1: baseURL の上書き
      # ==========================================================
      - name: Build Hugo site (Override baseURL)
        # Hugoコマンドに Variables の値（フルURL）を直接渡す
        run: hugo --minify --baseURL ${{ vars.CUSTOM_DOMAIN }} 


      # ==========================================================
      # 🛠️ 修正 2: CNAME ファイルの動的作成（構文エラー回避のため修正）
      # ==========================================================
      # 複数のコマンドを '|' で囲むことで、単一のスクリプトとして実行させる
      - name: Create CNAME file from Variable
        shell: bash 
        run: |
          # 環境変数から値を取得
          FULL_URL="${{ vars.CUSTOM_DOMAIN }}"
          
          # 1. https:// を削除
          DOMAIN_ONLY="${FULL_URL/https:\/\//}"
          
          # 2. 末尾の / を削除（もしあれば）
          DOMAIN_ONLY="${DOMAIN_ONLY/\//}"
          
          # 3. public/CNAME にドメイン名のみを書き込む
          echo "${DOMAIN_ONLY}" > ./public/CNAME
          echo "✅ CNAME file created with: ${DOMAIN_ONLY}"


      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          force_orphan: true