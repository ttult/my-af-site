name: Deploy Hugo site to GitHub Pages

on:
  push:
    branches:
      - main  # ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã«pushã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # ğŸ“ ç’°å¢ƒå¤‰æ•°ã‚’å®šç¾©ã—ã¦ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã® Variables ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
    env:
      CUSTOM_DOMAIN_URL: ${{ vars.CUSTOM_DOMAIN }} # https://www.ultimateroom.net
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true  # ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆãƒ†ãƒ¼ãƒï¼‰ã‚‚ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
          fetch-depth: 0    # ã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒå±¥æ­´ã‚’å–å¾—

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'

      # ==========================================================
      # ğŸ› ï¸ ä¿®æ­£ 1: baseURL ã‚’ Variables ã‹ã‚‰å–å¾—ã—ãŸå€¤ã§ä¸Šæ›¸ãã™ã‚‹
      # ==========================================================
      - name: Build Hugo site (Override baseURL)
        # --baseURL ãƒ•ãƒ©ã‚°ã« Variables ã®å€¤ï¼ˆãƒ•ãƒ«URLï¼‰ã‚’æ¸¡ã™
        run: hugo --minify --baseURL ${{ env.CUSTOM_DOMAIN_URL }} 
        # (æ³¨: ã“ã“ã§ .env.CUSTOM_DOMAIN_URL ã‚’ä½¿ã†ãŸã‚ã€jobs ãƒ¬ãƒ™ãƒ«ã® env ã«è¨­å®šã—ã¦ã„ã¾ã™)

      # ==========================================================
      # ğŸ› ï¸ ä¿®æ­£ 2: CNAME ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‹•çš„ã«ä½œæˆã™ã‚‹
      # ==========================================================
      - name: Create CNAME file from Variable
        run: |
          # 1. URLã‹ã‚‰ 'https://' ã¨æœ«å°¾ã® '/' ã‚’å–ã‚Šé™¤ã (ãƒ‰ãƒ¡ã‚¤ãƒ³åã®ã¿æŠ½å‡º)
          # Bashã®æ–‡å­—åˆ—ç½®æ›æ©Ÿèƒ½ã‚’ä½¿ç”¨: ${å¤‰æ•°/æ¤œç´¢ãƒ‘ã‚¿ãƒ¼ãƒ³/ç½®æ›æ–‡å­—åˆ—}
          DOMAIN_ONLY=${CUSTOM_DOMAIN_URL/https:\/\//} 
          DOMAIN_ONLY=${DOMAIN_ONLY/\//}
          
          # 2. public/CNAME ã«ãƒ‰ãƒ¡ã‚¤ãƒ³åã®ã¿ã‚’æ›¸ãè¾¼ã‚€
          echo "${DOMAIN_ONLY}" > ./public/CNAME
          echo "âœ… CNAME file created with: ${DOMAIN_ONLY}"


      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          force_orphan: true # æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã§ç½®ãæ›ãˆã‚‹